name: Deploy Chipitiempo to VPS

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add host to known_hosts
        run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            set -e  # Exit on error
            
            REPO_ROOT="/var/www/vhosts/chipitiempo"
            DEPLOY_DIR="${REPO_ROOT}/httpdocs"
            
            echo "=========================================="
            echo "[$(date)] ðŸš€ Iniciando despliegue ChipiTiempo"
            echo "=========================================="
            
            # Verificar estructura de directorios
            echo "[$(date)] ðŸ“‚ Estructura de directorios:"
            ls -la "$REPO_ROOT" | head -20
            
            # Ir al directorio de despliegue
            cd "$DEPLOY_DIR"
            echo "[$(date)] ðŸ“ Directorio actual: $(pwd)"
            
            # Descargar cambios
            echo ""
            echo "[$(date)] ðŸ“¥ Descargando cambios del repositorio..."
            git fetch origin prod
            git reset --hard origin/prod
            
            # Generar HTML (pasando ruta absoluta para asegurar que se guarde en httpdocs)
            echo ""
            echo "[$(date)] ðŸ”§ Generando index.html..."
            php generate.php "${DEPLOY_DIR}/index.html" 2>&1
            
            # Verificar que el archivo se generÃ³ correctamente
            echo ""
            echo "[$(date)] âœ… Verificando archivo generado..."
            
            if [ -f "${DEPLOY_DIR}/index.html" ] && [ -s "${DEPLOY_DIR}/index.html" ]; then
              SIZE=$(wc -c < "${DEPLOY_DIR}/index.html")
              MODIFIED=$(date -r "${DEPLOY_DIR}/index.html" "+%Y-%m-%d %H:%M:%S")
              echo "[$(date)] âœ“ index.html generado correctamente"
              echo "[$(date)]   ðŸ“Š TamaÃ±o: $SIZE bytes"
              echo "[$(date)]   ðŸ• Hora: $MODIFIED"
              echo "[$(date)]   ðŸ“ UbicaciÃ³n: ${DEPLOY_DIR}/index.html"
            else
              echo "[$(date)] âœ— ERROR: index.html no existe o estÃ¡ vacÃ­o en ${DEPLOY_DIR}/"
              ls -la "${DEPLOY_DIR}/" 2>&1 || true
              exit 1
            fi
            
            # Establecer permisos (importantes para Plesk)
            echo ""
            echo "[$(date)] ðŸ” Estableciendo permisos..."
            chmod 644 "${DEPLOY_DIR}/index.html"
            chmod 755 "${DEPLOY_DIR}"
            
            # Verificar permisos
            ls -lh "${DEPLOY_DIR}/index.html"
            
            # Limpiar archivos temporales si existen
            echo ""
            echo "[$(date)] ðŸ§¹ Limpiando archivos temporales..."
            rm -f "${DEPLOY_DIR}/generate.log"
            
            # InformaciÃ³n final
            echo ""
            echo "[$(date)] ðŸ“Š VerificaciÃ³n final:"
            echo "[$(date)]   Inodes de index.html:"
            ls -i "${DEPLOY_DIR}/index.html" "${REPO_ROOT}/index.html" 2>&1 || true
            echo "[$(date)]   Content-Length:"
            wc -c "${DEPLOY_DIR}/index.html" 2>&1 || true
            
            echo ""
            echo "=========================================="
            echo "[$(date)] âœ¨ Despliegue completado exitosamente"
            echo "=========================================="
          ENDSSH